# local.d/multimap.conf

{
if ($rspamd{SpamCheckStatus} eq 'enabled') {

$OUT .= << 'EOF' 

# whitelist the IP
IP_WHITELIST {
    type = "ip";
    prefilter = "true";
    map = "${CONFDIR}/whitelist_ip.map";
    action = "accept";
    symbol = "IP_WHITELIST";
    description = "Accept SMTP sender by exact IP address";
  }

# whitelist the senders
FROM_WHITELIST {
    type = "from";
    map = [
    "${CONFDIR}/whitelist_from.map",
    ];
    prefilter = true;
    filter = "email:addr";
    action = "accept";
    description = "Accept SMTP sender by exact email address";
    symbol = "FROM_WHITELIST";
}

# whitelist the domains of senders. A 2nd level domain matches also its subdomains.
FROM_DOMAINS_WHITELIST {
    type = "combined";
    expression = "wl_from_domains || wl_from_subdomains";
    prefilter = true;
    action = "accept";
    description = "Accept SMTP sender by domain name match";
    rules {
        wl_from_domains {
            map = "${CONFDIR}/whitelist_from_domains.map";
            type = "from";
            filter = "email:domain:tld";
        }
        wl_from_subdomains {
            map = "${CONFDIR}/whitelist_from_subdomains.map";
            type = "from";
            filter = "email:domain";
        }
    }
}

#blacklist the senders
FROM_BLACKLIST {
    type = "from";
    map = [
    "${CONFDIR}/blacklist_from.map",
    ];
    action = "reject";
    prefilter = true;
    filter = "email:addr";
    symbol = "FROM_BLACKLIST";
    description = "Reject SMTP sender by exact email address";
    message = "Sender address rejected";
}

# blacklist the domains of senders
FROM_DOMAINS_BLACKLIST {
    type = "combined";
    expression = "bl_from_domains || bl_from_subdomains";
    prefilter = true;
    action = "reject";
    description = "Reject SMTP sender by domain name match";
    message = "Sender domain address rejected";
    rules {
        bl_from_domains {
            map = "${CONFDIR}/blacklist_from_domains.map";
            type = "from";
            filter = "email:domain:tld";
        }
        bl_from_subdomains {
            map = "${CONFDIR}/blacklist_from_subdomains.map";
            type = "from";
            filter = "email:domain";
        }
    }
}

# whitelist the domain of recipients
TO_DOMAINS_WHITELIST {
    type = "combined";
    expression = "wl_to_domains || wl_to_subdomains";
    prefilter = true;
    action = "accept";
    description = "Accept SMTP recipient by domain name match";
    rules {
        wl_to_domains {
            map = "${CONFDIR}/whitelist_to_domains.map";
            type = "rcpt";
            filter = "email:domain:tld";
        }
        wl_to_subdomains {
            map = "${CONFDIR}/whitelist_to_subdomains.map";
            type = "rcpt";
            filter = "email:domain";
        }
    }
}

#whitelist the email address of recipients
TO_WHITELIST {
    type = "rcpt";
    map = [
    "${CONFDIR}/whitelist_to.map",
    ];
    prefilter = true;
    filter = "email:addr";
    action = "accept";
    description = "Accept SMTP recipient by exact email address";
    symbol = "TO_WHITELIST";
}
EOF

}

if ($rspamd{BlockAttachmentStatus} eq 'enabled') {
$OUT .= << 'EOF'

#reject email when the file extension is found
    FORBIDDEN_FILE_EXTENSION {
    type = "filename";
    filter = "extension";
    map = [
    "${CONFDIR}/forbidden_file_extension.map",
    ];
    action = "reject";
    symbol = "FORBIDDEN_FILE_EXTENSION";
    description = "List of forbidden file extensions";
    message = "Forbidden attachment name extension";
}
EOF
}
}
